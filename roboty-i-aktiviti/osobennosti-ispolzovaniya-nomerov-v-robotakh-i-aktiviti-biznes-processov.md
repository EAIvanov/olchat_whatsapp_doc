# Особенности использования номеров в роботах и активити бизнес-процессов

Практически в каждом роботе или активити вам предстоит использовать номер телефона. Давайте разберёмся, как это делать правильно.

В карточке CRM (лид, контакт, компания) есть возможность использовать как один, так и несколько номеров телефонов, причём с разными типами (мобильный, рабочий, для рассылок, другой, и т.д.).

Если номер один, то вопросов обычно не возникает. Проблемы появляются, когда номеров несколько. В этом случае важно учитывать на какой и на сколько номеров вы отправляете сообщение.

Когда вы передаёте номер (номера) телефонов в робот или активити, то они могут передаваться как массив номеров – **\{{Телефон\}} / {=Document:PHONE}** (также **\{{Контакт: Телефон\}}** и **\{{Компания: Телефон\}}**) или как текстовая строка – **\{{Телефон (текст)\}}** **/ {=Document:PHONE\_PRINTABLE}** (также **\{{Контакт: Телефон (текст)\}}** и **\{{Компания: Телефон (текст)\}}**).

{% hint style="warning" %}
Обратите внимание, что переменная **\{{Телефон\}} / {=Document:PHONE} / \{{Контакт: Телефон\}} / \{{Компания: Телефон\}}** или **\{{Телефон (текст)\}} / {=Document:PHONE\_PRINTABLE}** **/ \{{Контакт: Телефон (текст)\}} / \{{Компания: Телефон (текст)\}}** собирает и передаёт номера ВСЕХ типов.

**Если в робот передан подобный массив номеров или текстовая строка с номерами и их там несколько – отправка будет осуществлена на первый номер в списке, на котором есть WhatsApp!**
{% endhint %}

Для того, чтобы исключить ошибки, можно воспользоваться одним из способов, описанных ниже:

### **Используйте отдельный тип телефона для отправки сообщений в WhatsApp**

Например, «Для рассылок». Возможные варианты, которые могут принимать переменные:

* \{{Телефон для рассылок\}} / Document:PHONE\_MAILING}
* \{{Контакт: Телефон для рассылок\}}
* \{{Компания: Телефон для рассылок\}}
* \{{Телефон для рассылок (текст)\}}
* \{{Контакт: Телефон для рассылок (текст)\}}
* \{{Компания: Телефон для рассылок (текст)\}}

При настройке робота или активити используйте один из вариантов переменной, подставляя её в поле **Номер телефона (кому отправляем)**

<figure><img src="../.gitbook/assets/image (1059).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (133).png" alt=""><figcaption></figcaption></figure>

### **Используйте** [**функцию firstvalue**](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=57\&LESSON_ID=4912) для указания первого значения из массива номеров.

При использовании функции **firstvalue** из массива номеров **\{{Телефон\}} / {=Document:PHONE} / \{{Контакт: Телефон\}} / \{{Компания: Телефон\}}** будет выбран и подставлен в робот или активити первый по счёту номер.

При настройке робота используйте один из возможных вариантов конструкций, подставляя её в поле **Номер телефона (кому отправляем):**

* \{{=firstvalue(\{{Телефон\}})\}}
* \{{=firstvalue(\{{Контакт: Телефон\}})\}}
* \{{=firstvalue(\{{Компания: Телефон\}})\}}

<figure><img src="../.gitbook/assets/image (405).png" alt=""><figcaption></figcaption></figure>

Для вызова окна функций в активити бизнес-процесса введите в поле для ввода номера телефона знак «равно» и в открывшемся окне выберите функцию **firstvalue.**

<figure><img src="../.gitbook/assets/image (725).png" alt=""><figcaption></figcaption></figure>

В круглых скобках функции укажите массив номеров, из которых нужно выбрать первое значение. Например, **\{{Контакт: Телефон\}}.**

<figure><img src="../.gitbook/assets/image (178).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Обратите внимание, что при использовании функции **firstvalue** переменную **\{{Телефон\}} / \{{Контакт: Телефон\}} / \{{Компания: Телефон\}}** нужно передавать без модификатора «(текст)», т.к. важно передавать именно массив номеров.
{% endhint %}

### **Используйте активити** [**Итератор**](https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=57\&LESSON_ID=10481)**,** чтобы перебрать номера в массиве и задать свою логику для каждого из номеров массива

{% hint style="warning" %}
Данный способ работает только в том случае, если на вашем тарифе Битрикс24 доступен дизайнер Бизнес-процессов!
{% endhint %}

Создайте переменную бизнес-процесса

![](<../.gitbook/assets/image (970).png>)

Добавьте активити «Изменение переменных» и «Итератор»

Установите переменную для этих активити

![](<../.gitbook/assets/image (674).png>)

![](<../.gitbook/assets/image (1058).png>)

Внутри итератора будут перебираться номера телефонов и вы сможете выполнять проверки и производить действия с каждым номером.

{% hint style="info" %}
Помните, что во всех вышеописанных способах вам необходимо учитывать ещё одно обстоятельство, а именно – наличие WhatsApp на номере, на который делается отправка.

В настоящее время проверка номера на наличие WhatsApp осуществляется сразу при отправке сообщения. Если отправка осуществляется на номер, на котором не установлен WhatsApp, в дополнительных результатах выполнения активити вы получите ошибку **«NW»** а в описании ошибки — более развёрнутое её описание: **«Ошибка при отправке: телефонный номер 7961\*\*\*\*\*57 не найден в WhatsApp»**
{% endhint %}

<figure><img src="../.gitbook/assets/image (663).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Если вы хотите явно получить результат проверки номера на наличие WhatsApp и использовать его в ваших сценариях работы, проверку номера из массива номеров на наличие WhatsApp можно также осуществлять с помощью итератора. Подробнее в статье [proverka-telefona.md](roboty/proverka-telefona.md "mention")
{% endhint %}
