# Как повысить эффективность робота Ожидание сообщения

{% hint style="warning" %}
Для реализации функционала описанного в данном примере, необходим тариф Битрикс24 с бизнес-процессами!
{% endhint %}

### Описание кейса

При использовании робота [ozhidanie-soobsheniya.md](../../roboty-i-aktiviti/roboty/ozhidanie-soobsheniya.md "mention") вы, как правило, ожидаете получить от клиента определённый текст сообщения, соответствующий одному из сценариев, по которому движется процесс.

Однако, не редко может возникнуть ситуация, когда клиент отвечает вам не так, как вы ожидаете от него и ваш процесс может «сломаться»:

<figure><img src="../../.gitbook/assets/image (1116).png" alt=""><figcaption></figcaption></figure>

Для обработки подобного рода ответов, можно воспользоваться стандартной конструкцией бизнес-процессов – [Цикл](https://dev.1c-bitrix.ru/learning/course/?COURSE_ID=57\&LESSON_ID=3792), внутри которой разместить проверку ответа клиента на соответствие нашим ожиданиям, и в случае, если клиент ответил не так – ещё раз попросить его ответить определённым образом. Например, отправить вариант ответа только цифрой.

Выполним настройку подобного сценария.

### Настройка сценария

#### 1 Настройка действия Отправка сообщения

Добавим действие [ozhidanie-soobsheniya.md](../../roboty-i-aktiviti/roboty/ozhidanie-soobsheniya.md "mention") в котором напишем текст отправляемого сообщения:

<figure><img src="../../.gitbook/assets/image (1117).png" alt=""><figcaption></figcaption></figure>

#### 2 Настройка конструкции Цикл

Далее, добавим конструкцию Цикл и выполним её настройку. Для того, чтобы цикл не ушёл в рекурсию и не начал повторяться много раз, добавим переменную, которая ограничит количество повторений цикла. Например, не более двух раз.

<figure><img src="../../.gitbook/assets/image (1119).png" alt=""><figcaption></figcaption></figure>

Также добавим переменную для выхода из цикла, если клиент ответил соответственно нашим ожиданиям:

<figure><img src="../../.gitbook/assets/image (1120).png" alt=""><figcaption></figcaption></figure>

Настроим действие Цикл таким образом, как показано на скриншоте ниже:

<figure><img src="../../.gitbook/assets/image (1121).png" alt=""><figcaption></figcaption></figure>

Далее, внутрь конструкции Цикл поместим действие [ozhidanie-soobsheniya.md](../../roboty-i-aktiviti/roboty/ozhidanie-soobsheniya.md "mention") и выполним его настройку:

<figure><img src="../../.gitbook/assets/image (1122).png" alt=""><figcaption></figcaption></figure>

#### 3 Обработка ответов клиента

После того, как клиент ответил, необходимо проанализировать его ответ и понять, соответствует ли он нашим ожиданиям. Для этого добавим конструкцию Условие и выполним её настройку:

<figure><img src="../../.gitbook/assets/image (1123).png" alt=""><figcaption></figcaption></figure>

В ветке условия «Ответил правильно» укажем набор условий, которые позволят проверить ответ клиента на соответствие ожиданиям:

<figure><img src="../../.gitbook/assets/image (1124).png" alt=""><figcaption></figcaption></figure>

Если ответ клиента совпадёт с одним из условий и сценарий процесса пойдёт по данной ветке, следующим действием нам необходимо изменить переменную «Клиент ответил правильно?» на вариант «Да», чтобы выйти из Цикла и продолжить общение с клиентом, обработав выбранный им вариант.

В случае, если клиент ответил не только цифрой и мы не можем точно определить, какой вариант он выбрал, во второй ветке условия мы можем отправить клиенту сообщение с помощью действия [Broken link](broken-reference "mention") и попросить прислать только цифру ответа:

<figure><img src="../../.gitbook/assets/image (1125).png" alt=""><figcaption></figcaption></figure>

Следующим действием необходимо увеличить переменную «Количество повторений цикла» на 1, чтобы позволить процессу войти в цикл в последний раз:

<figure><img src="../../.gitbook/assets/image (1126).png" alt=""><figcaption></figcaption></figure>

Если после дополнительной просьбы ответить только цифрой клиент ответил правильно – с помощью следующего условия вы можете обработать конкретный ответ клиента и продолжить ваш сценарий автоматизации, как вам необходимо.

<figure><img src="../../.gitbook/assets/image (1127).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (1128).png" alt=""><figcaption></figcaption></figure>

Если клиент опять ответил неправильно, вы можете добавить ветку условия, в которой можно уведомить Пользователя-владельца чата о том, что возникли сложности в процессе получения обратной связи от клиента и что необходимо подключиться к диалогу и пообщаться лично.

#### 4 Уведомление владельцу чата

Чтобы узнать владельца чата и отправить ему уведомление, потребуется добавить два дополнительных действия: «\[OLChat] \[ОЛ] Получить информацию о чате из WhatsApp», которое позволит получить ID чата и «\[OLChat] \[ОЛ] Информация о диалоге», которое может по ID чата вернуть ID Пользователя владельца чата.

В действии «\[OLChat] \[ОЛ] Получить информацию о чате из WhatsApp» укажите Линию и Номер телефона, для которых производится получение информации о чате.

<figure><img src="../../.gitbook/assets/image (1129).png" alt=""><figcaption></figcaption></figure>

В действии «\[OLChat] \[ОЛ] Информация о диалоге» в поле **Тип идентификатора** укажите значение **Идентификатор чата (число),** а в поле **Значение идентификатора** – ID чата из дополнительных результатов активити «\[OLChat] \[ОЛ] Получить информацию о чате из WhatsApp».

<figure><img src="../../.gitbook/assets/image (1130).png" alt=""><figcaption></figcaption></figure>

Для того, чтобы уведомить владельца чата о проблеме, возникшей в процессе общения с клиентом, потребуется добавить действие «Уведомление пользователя». В качестве Получателя уведомления необходимо указать пользователя, кому будет отправлено уведомление.

Однако действие «\[OLChat] \[ОЛ] Информация о диалоге» вернёт ID Владельца чата в виде числа, а действие «Уведомление пользователя» ожидает получить другой тип данных – Пользователя.

Чтобы преобразовать число в тип Пользователь и передать его в действие «Уведомление пользователя», потребуется ввести ещё одну переменную, в которой произведём преобразование данных, а именно, тип Число в тип Пользователь. Сделаем это с помощью добавления строки **user\_ к** ID Владельца чата из дополнительных результатов, как показано на скриншоте ниже:

<figure><img src="../../.gitbook/assets/image (1131).png" alt=""><figcaption></figcaption></figure>

На последнем этапе добавим уведомление. В качестве отправителя и получателя укажем переменную «Владелец чата». В тексте уведомления можем описать проблему и указать ссылку на диалог:

<figure><img src="../../.gitbook/assets/image (1132).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Подробнее о том, как создать ссылку на чат описано в статье[kak-dat-ssylku-na-konkretnyi-chat.md](../../voprosy-i-otvety/rabota-s-chatami/kak-dat-ssylku-na-konkretnyi-chat.md "mention")
{% endhint %}

#### 5 Схема процесса, примеры общения в чате

Полностью настроенная схема бизнес-процесса выглядит следующим образом:

<figure><img src="../../.gitbook/assets/image (1134).png" alt=""><figcaption></figcaption></figure>

Общение в чате может выглядеть следующим образом:

<figure><img src="../../.gitbook/assets/image (1135).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Ниже вы можете скачать шаблон рассмотренного бизнес-процесса и импортировать его в ваш бизнес-процесс для подробного рассмотрения и настройки. Подробнее об импорте шаблонов в статье Битрикс24 [Экспорт и импорт шаблонов бизнес-процессов](https://helpdesk.bitrix24.ru/open/5435897/).
{% endhint %}

{% file src="../../.gitbook/assets/Цикл для робота Ожидание сообщения.bpt" %}

{% hint style="warning" %}
Данный пример процесса не является готовым и универсальным решением, охватывающим множество вариантов сценариев и различные задачи. Его цель — последовательно продемонстрировать возможный сценарий обработки нестандартных ответов пользователя при использовании робота [ozhidanie-soobsheniya.md](../../roboty-i-aktiviti/roboty/ozhidanie-soobsheniya.md "mention").

Ветка условий для обработки правильных ответов не настраивалась и может быть настроена по вашему усмотрению.
{% endhint %}
